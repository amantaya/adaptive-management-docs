---
title: "Clean Up Tables from Access Database"
author: ""
date: "3/28/2022"
output:
  pdf_document: default
  toc: true
---

## Setup 

Remove all of the objects from the R environment to start fresh every time.

```{r remove objects}
rm(list = ls())
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "~/adaptive-management-docs")
```

```{r load all packages}
source("scripts/packages.R")
```

```{r load custom functions}
source("scripts/functions.R")
```

## Load Data

```{r add file path}
path_to_excel_file <- file.path("data", "adaptive_management_documents_asessment_export_all_tables_from_access.xlsx")

print(path_to_excel_file)
```

Read in the sheet names from the Excel workbook.

```{r get sheet names}
sheet_names <- openxlsx::getSheetNames(path_to_excel_file)

print(sheet_names)
```

```{r load data from Excel}
all_excel_sheets_list <- lapply(sheet_names, openxlsx::read.xlsx, xlsxFile = path_to_excel_file)

all_excel_sheets_list
```

The "convert_from_excel_dates_to_datetime" function now uses a column name parameter that performs the clean up function on an column in the data frame that matches the column name supplied in the function parameter.

```{r set sheet names}
names(all_excel_sheets_list) <- sheet_names

names(all_excel_sheets_list)
```

## Clean Up Dates

The variously named "Date" columns in each Excel sheet were read in as doubles, as that is how they are stored in Excel.

```{r preview dates from a dataframe}
all_excel_sheets_list$tblTnELimits_Doc %>% select(Date.Entered)
```

We want to display Date columns as a `datetime` class inside of R. 

We created a function that helps convert each "Date" column from within each data frame,
and then converts it to a `datetime` class. This funciton takes the name of the column as an input.

We will preview what the function does before we apply it to our data.

```{r preview convert dates function}
df <- all_excel_sheets_list$tblTnELimits_Doc

convert_from_excel_dates_to_datetime(df, "Date.Entered")
```

Now that we know what the function does, we can apply it to each "Date" column in our data.

Note that `purrr:map()` will apply our function to every column named "Date.Entered" in our data.

```{r map clean dates function to column "Date.Entered"}
all_excel_sheets_cleaned_date_entered <- purrr::map(all_excel_sheets_list,
  convert_from_excel_dates_to_datetime,
  col_name = "Date.Entered"
)
```

Some more information about the various "Date" columns in our data.

The "CodingDate" column means exactly the same as "Date.Entered" and we can rename that column to be the same thing. Then we could run our function on the previously names "CodingDate" column.

The "DateOn" and "DateOff" columns are the dates that cows were turned out onto pasture and removed from pastures. These columns also need to be converted into Date class.

In the "DocSpecs" data frame the "DocYear" column was coded in using a table of codes from the table dmnSpecs.

```{r map clean dates function to column "DateOn"}
all_excel_sheets_cleaned_dateon <- purrr::map(all_excel_sheets_cleaned_date_entered,
  convert_from_excel_dates_to_datetime,
  col_name = "DateOn"
)
```

```{r map clean dates function to column "DateOff"}
all_excel_sheets_cleaned_dateoff <- purrr::map(all_excel_sheets_cleaned_dateon,
  convert_from_excel_dates_to_datetime,
  col_name = "DateOff"
)
```

```{r map clean dates function to column "DateOff"}
all_excel_sheets_cleaned_dateoff <- purrr::map(all_excel_sheets_cleaned_dateon,
  convert_from_excel_dates_to_datetime,
  col_name = "DateOff"
)
```


```{r map clean dates function to column "CodingDate"}
all_excel_sheets_cleaned_coding_date <- purrr::map(all_excel_sheets_cleaned_dateoff,
  convert_from_excel_dates_to_datetime,
  col_name = "CodingDate"
)
```

The datetimes below are in the wrong time zone. They are displaying in the UTC time zone, but the data was actually entered in with GMT -7 time zone. 

```{r map clean dates function to column "datDate.Entered"}
all_excel_sheets_cleaned_datdate_entered <- purrr::map(all_excel_sheets_cleaned_coding_date,
  convert_from_excel_dates_to_datetime,
  col_name = "datDate.Entered"
)
```

```{r map clean dates function to column "datValidStart"}
all_excel_sheets_cleaned_allot_specs_table <- purrr::map(all_excel_sheets_cleaned_datdate_entered,
  convert_from_excel_dates_to_datetime,
  col_name = "datValidStart"
)
```

```{r map clean dates function to column "datValidEnd"}
all_excel_sheets_cleaned_allot_specs_table <- purrr::map(all_excel_sheets_cleaned_allot_specs_table,
  convert_from_excel_dates_to_datetime,
  col_name = "datValidEnd"
)
```

```{r map clean dates function to column "datPermitStart"}
all_excel_sheets_cleaned_allot_specs_table <- purrr::map(all_excel_sheets_cleaned_allot_specs_table,
  convert_from_excel_dates_to_datetime,
  col_name = "datPermitStart"
)
```

```{r map clean dates function to column "datPermitEnd"}
all_excel_sheets_cleaned_allot_specs_table <- purrr::map(all_excel_sheets_cleaned_allot_specs_table,
  convert_from_excel_dates_to_datetime,
  col_name = "datPermitEnd"
)
```

```{r map clean dates function to column "DateEntered"}
all_excel_sheets_cleaned_allot_specs_table <- purrr::map(all_excel_sheets_cleaned_allot_specs_table,
  convert_from_excel_dates_to_datetime,
  col_name = "DateEntered"
)
```

## Rename Columns 

There are many columns that we need to rename in the database.

The table "dmnYears" contains a code for entering in the document year in the "DocYear" column in other tables. In "dmnYears" year 1996 is coded as "7". Not sure why. The table "tblDocSpecs" contains only a "DocYear" column so we want to replace those coded values with the actual year of the document.

```{r Rename "ID" to "DocYear" in "dmnYears"}
all_excel_sheets_cleaned_allot_specs_table$dmnYears <- all_excel_sheets_cleaned_allot_specs_table$dmnYears %>% 
  dplyr::rename(DocYear = ID)

all_excel_sheets_cleaned_allot_specs_table$dmnYears
```

## Join "dmnYears" and "tblDocSpecs"

The right join will match the "DocYear" value from the "dmnYears" table with the "DocYear" value in the "tblDocSpecs" table and replace the "DocYear" value in the "tblDocSpecs" table with the "Date_Year" from the "dmnYEars".

```{r right join "dmnYears" and "tblDocSpecs" by "DocYear"}
all_excel_sheets_cleaned_allot_specs_table$tblDocSpecs <- dplyr::right_join(all_excel_sheets_cleaned_allot_specs_table$dmnYears, all_excel_sheets_cleaned_allot_specs_table$tblDocSpecs, by = "DocYear")

all_excel_sheets_cleaned_allot_specs_table$tblDocSpecs
```

We will drop the "DocYear" column from the "tblDocSpecs" data frame, and then rename the "Date_Year" column to be called "AOI_Year". Renaming the column to "AOI_Year" better represents the meaning on the column. The "AOI_Year"

## TODO refactor to overwrite excel list instead of creating new objects

```{r drop "DocYear" from "tblDocSpecs" and rename to "AOI_Year"}
all_excel_sheets_cleaned_allot_specs_table$tblDocSpecs <-
  all_excel_sheets_cleaned_allot_specs_table$tblDocSpecs %>%
  dplyr::select(-(DocYear)) %>% 
  dplyr::rename(AOI_Year = Date_Year) %>% 
  dplyr::arrange(DocNo)
all_excel_sheets_cleaned_allot_specs_table$tblDocSpecs
```

Write Partially Cleaned Data to CSV File

```{r Write Intermediate Data to CSV, eval=FALSE}
openxlsx::write.xlsx(all_excel_sheets_cleaned_allot_specs_table, file.path("data", "01-intermediate-clean-excel-dates-and-join-docyear-on-table-docspecs.xlsx"))
```

## Rename List of Data Frames

Rename the list to something smaller and easier to type.

```{r rename to "all_excel_sheets_cleaned"}
all_excel_sheets_cleaned <- all_excel_sheets_cleaned_allot_specs_table
```

## Clean Up "tblTnELimits_Doc" 

Before we join the "tblTnELimits_Doc" with the "tblDocSpecs" on the "DocNo" column, we will use `dplyr::semi_join()` to see which rows in "tblDocSpecs" have a match in "tblTnELimits_Doc".

```{r semi-join }
dplyr::semi_join(all_excel_sheets_cleaned$tblDocSpecs,
  all_excel_sheets_cleaned$tblTnELimits_Doc,
  by = "DocNo"
)
```

There are 2,360 rows in the "tblDocSpecs" but there are only 2,302 matches. That means that there are 58 rows that do not match.

```{r nrows in "tblDocSpecs"}
all_excel_sheets_cleaned$tblDocSpecs %>% nrow()
```

## TODO ask why we only kept these columns

```{r drop columns from "tblTnELimits_Doc"}
all_excel_sheets_cleaned$tblTnELimits_Doc <-
  all_excel_sheets_cleaned$tblTnELimits_Doc %>%
  dplyr::select(Limitation, DocNo)
```

## TODO not sure if we need this anymore or if it was just for prototyping

Before we change "tblDocSpecs" we want to see how each type of join will affect the data.
The function `right_join()` will join matching values from "tblDocSpecs" into "tblTnELimits_Doc".

We created a new object "all_excel_sheets_cleaned_right_join" to temporarily store the data so we can compare against other types of joins.

```{r}
all_excel_sheets_cleaned_right_join <- all_excel_sheets_cleaned

all_excel_sheets_cleaned_right_join$tblDocSpecs <- 
  dplyr::right_join(
    all_excel_sheets_cleaned_right_join$tblDocSpecs,
    all_excel_sheets_cleaned_right_join$tblTnELimits_Doc,
    by = "DocNo"
)
print(all_excel_sheets_cleaned_right_join$tblDocSpecs)
```

## TODO not sure if we need this anymore or if it was just for prototyping

We'll do the same thing as we just did with `right_join()` but this time we will use the function `full_join()`.

```{r}
all_excel_sheets_cleaned_full_join <- all_excel_sheets_cleaned

all_excel_sheets_cleaned_full_join$tblDocSpecs <-
  dplyr::full_join(all_excel_sheets_cleaned_full_join$tblDocSpecs,
    all_excel_sheets_cleaned_full_join$tblTnELimits_Doc,
    by = "DocNo"
  )

all_excel_sheets_cleaned_full_join$tblDocSpecs
```

The anti join is telling us that there are 58 additional rows in the full join that did not match.

```{r anti join}
anti_join(
  all_excel_sheets_cleaned_full_join$tblDocSpecs,
  all_excel_sheets_cleaned_right_join$tblDocSpecs
)
```

When we joined, the column "DocNo" in the sheet "tblDocSpecs" the new data was added 

```{r}
all_excel_sheets_cleaned_full_join_arrange <-
  all_excel_sheets_cleaned_full_join

all_excel_sheets_cleaned_full_join_arrange$tblDocSpecs <- all_excel_sheets_cleaned_full_join$tblDocSpecs %>%
  arrange(DocNo)

print(all_excel_sheets_cleaned_full_join_arrange$tblDocSpecs)
```

## TODO decide if we want to replace the "N/A" strings with true NA values

We might decide to replace the "N/A" values are true NA values, but for now, let's replace "N/A" with "None"

```{r}
# all_excel_sheets_cleaned_full_join_arrange$tblDocSpecs$Limitation <- str_replace_all(all_excel_sheets_cleaned_full_join_arrange$tblDocSpecs$Limitation, "N/A", NA_character_)
#
# View(all_excel_sheets_cleaned_full_join_arrange$tblDocSpecs)
```

The limitation column represents limitations placed on each allotment related to threatened and endangered species present on the allotment, or concerns related to T/E species. 

```{r}
all_excel_sheets_cleaned_full_join_arrange$tblDocSpecs$Limitation <-
  str_replace_all(
    all_excel_sheets_cleaned_full_join_arrange$tblDocSpecs$Limitation,
    "N/A",
    "None"
  )

all_excel_sheets_cleaned_full_join_arrange$tblDocSpecs
```

## 2.1

```{r Write Partially Cleaned Data Step 02, eval=FALSE, include=FALSE}
openxlsx::write.xlsx(
  all_excel_sheets_cleaned_full_join_arrange,
  file.path("data", "02-intermediate-full-join-limitations-doc-specs.xlsx")
)
```

## 3.0

```{r}
all_excel_sheets_cleaned_full_join_arrange$tblTnE_Doc
```

```{r}
all_excel_sheets_drop_duplicate_common_names <- all_excel_sheets_cleaned_full_join_arrange

all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc <-
  all_excel_sheets_cleaned_full_join_arrange$tblTnE_Doc %>%
  group_by(DocNo) %>%
  dplyr::distinct(CommonName)

all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc
```

Let's see how many rows were dropped when we used the distinct() function. 

```{r}
full <- all_excel_sheets_cleaned_full_join_arrange$tblTnE_Doc$CommonName %>% length()

drop_dupl <- all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc$DocNo %>% length()

full - drop_dupl
```

### Write Intermediate Data to CSV Step 03

```{r eval=FALSE, include=FALSE}
openxlsx::write.xlsx(
  all_excel_sheets_drop_duplicate_common_names,
  file.path("data", "03-intermediate-drop-duplicate-common-names-tnedoc.xlsx")
)
```

## Step 04

```{r}
all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc
```

We need to visualize how many Common Names are for each group to understand how many times we need to perform a clean up.

```{r}
all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc %>% dplyr::group_size()
```

```{r}
all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc %>%
  pull(CommonName) %>%
  unique()
```

```{r}
all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc %>%
  dplyr::pull(CommonName) %>%
  stringr::str_trim() %>%
  unique()
```

```{r}
all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc$CommonName <-
  all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc %>%
  dplyr::pull(CommonName) %>%
  stringr::str_trim()
print(all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc)
```

### Write Partially Cleaned Data to CSV Step 04

```{r eval=FALSE, include=FALSE}
openxlsx::write.xlsx(
  all_excel_sheets_drop_duplicate_common_names,
  file.path(
    "data",
    "04-intermediate-remove-leading-whitespaces-from-tblTnE_Doc.xlsx"
  )
)
```


## Step 05

Collapse each common name from tblTnE_Doc into single column.

```{r}
all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc_collapse <-
  all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc %>%
  summarise(CommonName = paste(CommonName, collapse = "; "))
print(all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc_collapse)
```

This equals the number of rows that we collapse using the `group_by` method.

```{r}
orig <- all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc %>%
  nrow()
remov_dup <- all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc_collapse %>%
  nrow()

orig - remov_dup
```

Here we over-write the original data with the collapsed "CommonName" column.

```{r}
all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc <-
  all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc %>%
  summarise(CommonName = paste(CommonName, collapse = "; "))
print(all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc)
```


## Step 05

```{r eval=FALSE, include=FALSE}
openxlsx::write.xlsx(
  all_excel_sheets_drop_duplicate_common_names,
  file.path(
    "data",
    "05-intermediate-collapse-common-names-from-tblTnE_Doc.xlsx"
  )
)
```


## TODO a couple of extra spaces in the "Modified Time/Place of Grazing" that we need to clean up

The the  "Modified Time/Place of Grazing" in the "Limitation" has an extra space in the one of the values that we need to get rid of.

```{r}
all_excel_sheets_drop_duplicate_common_names
```

## TODO the "None" from the CommonName column in tblTnE_Doc is mutually exclusive, meaning that "None" cannot also exclusive. We decided to keep the "None" in the data and will 

## 6.0 Full Join `tblTnE_Doc` with `tblDocSpecs` by `DocNo`

```{r}
all_excel_sheets_drop_duplicate_common_names$tblTnELimits_Doc <- 
  full_join(all_excel_sheets_drop_duplicate_common_names$tblDocSpecs,
          all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc,
          by = "DocNo") %>% 
  dplyr::relocate(CommonName, .before = Limitation)
print(all_excel_sheets_drop_duplicate_common_names$tblTnELimits_Doc)
```


```{r temp}
all_excel_sheets_drop_duplicate_common_names$tblDocSpecs %>% names()
```

```{r temp}
all_excel_sheets_drop_duplicate_common_names$tblClimeChange_Doc %>% names()
```

## Full Join with `tblDocSpecs` and `tblClimeChange_Doc` by `DocNo`


```{r}
anti_join(all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc, 
          all_excel_sheets_drop_duplicate_common_names$tblDocSpecs, 
          by = "DocNo") %>% View()
```

