---
title: "Clean Up Tables from Access Database"
author: ""
date: "3/28/2022"
output:
  pdf_document: default
  toc: true
---
# 

## Purpose

__The purpose of this Rmarkdown document is to clean up an Access database containing data related to grazing, for the purposes of studying adaptive management__

## Setup 

Remove all of the objects from the R environment to start fresh every time.

```{r remove objects}
rm(list = ls())
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = file.path("", "home", "rstudio", "adaptive-management-docs"))
```

```{r}
source(file.path("scripts", "environment.R"))
```

```{r load all packages}
source(file.path("scripts", "packages.R"))
```

```{r load custom functions}
source(file.path("scripts", "functions.R"))
```

## 1.0 Load Data

```{r add file path}
path_to_excel_file <- file.path("data", "adaptive_management_documents_asessment_export_all_tables_from_access.xlsx")

print(path_to_excel_file)
```

Read in the sheet names from the Excel workbook.

```{r get sheet names}
sheet_names <- openxlsx::getSheetNames(path_to_excel_file)

print(sheet_names)
```

Get all of the data from each of the sheets in Excel using `lapply()`.

```{r load data from Excel}
all_excel_sheets_list <- lapply(sheet_names, openxlsx::read.xlsx, xlsxFile = path_to_excel_file)

all_excel_sheets_list
```

The "convert_from_excel_dates_to_datetime" function now uses a column name parameter that performs the clean up function on an column in the data frame that matches the column name supplied in the function parameter.

```{r set sheet names}
names(all_excel_sheets_list) <- sheet_names

names(all_excel_sheets_list)
```

## 2.0 Clean Up Dates

The variously named "Date" columns in each Excel sheet were read in as doubles, as that is how they are stored in Excel.

```{r preview dates from a dataframe}
all_excel_sheets_list$tblTnELimits_Doc %>% select(Date.Entered)
```

We want to display Date columns as a `datetime` class inside of R. 

We created a function that helps convert each "Date" column from within each data frame,
and then converts it to a `datetime` class. This funciton takes the name of the column as an input.

We will preview what the function does before we apply it to our data.

```{r preview convert dates function}
df <- all_excel_sheets_list$tblTnELimits_Doc

convert_from_excel_dates_to_datetime(df, "Date.Entered")
```

Now that we know what the function does, we can apply it to each "Date" column in our data.

Note that `purrr:map()` will apply our function to every column named "Date.Entered" in our data.

```{r map clean dates function to column "Date.Entered"}
all_excel_sheets_cleaned_date_entered <- 
  purrr::map(all_excel_sheets_list, convert_from_excel_dates_to_datetime, col_name = "Date.Entered"
)
```

Some more information about the various "Date" columns in our data.

The "CodingDate" column means exactly the same as "Date.Entered" and we can rename that column to be the same thing. Then we could run our function on the previously names "CodingDate" column.

The "DateOn" and "DateOff" columns are the dates that cows were turned out onto pasture and removed from pastures. These columns also need to be converted into Date class.

In the "DocSpecs" data frame the "DocYear" column was coded in using a table of codes from the table dmnSpecs.

```{r map clean dates function to column "DateOn"}
all_excel_sheets_cleaned_dateon <- purrr::map(all_excel_sheets_cleaned_date_entered,
  convert_from_excel_dates_to_datetime,
  col_name = "DateOn"
)
```

```{r map clean dates function to column "DateOff"}
all_excel_sheets_cleaned_dateoff <- purrr::map(all_excel_sheets_cleaned_dateon,
  convert_from_excel_dates_to_datetime,
  col_name = "DateOff"
)
```

```{r map clean dates function to column "CodingDate"}
all_excel_sheets_cleaned_coding_date <- purrr::map(all_excel_sheets_cleaned_dateoff,
  convert_from_excel_dates_to_datetime,
  col_name = "CodingDate"
)
```

The datetimes below are in the wrong time zone. They are displaying in the UTC time zone, but the data was actually entered in with GMT -7 time zone. 

```{r map clean dates function to column "datDate.Entered"}
all_excel_sheets_cleaned_datdate_entered <- purrr::map(all_excel_sheets_cleaned_coding_date,
  convert_from_excel_dates_to_datetime,
  col_name = "datDate.Entered"
)
```

```{r map clean dates function to column "datValidStart"}
all_excel_sheets_cleaned_allot_specs_table <- purrr::map(all_excel_sheets_cleaned_datdate_entered,
  convert_from_excel_dates_to_datetime,
  col_name = "datValidStart"
)
```

```{r map clean dates function to column "datValidEnd"}
all_excel_sheets_cleaned_allot_specs_table <- purrr::map(all_excel_sheets_cleaned_allot_specs_table,
  convert_from_excel_dates_to_datetime,
  col_name = "datValidEnd"
)
```

```{r map clean dates function to column "datPermitStart"}
all_excel_sheets_cleaned_allot_specs_table <- purrr::map(all_excel_sheets_cleaned_allot_specs_table,
  convert_from_excel_dates_to_datetime,
  col_name = "datPermitStart"
)
```

```{r map clean dates function to column "datPermitEnd"}
all_excel_sheets_cleaned_allot_specs_table <- purrr::map(all_excel_sheets_cleaned_allot_specs_table,
  convert_from_excel_dates_to_datetime,
  col_name = "datPermitEnd"
)
```

```{r map clean dates function to column "DateEntered"}
all_excel_sheets_cleaned_allot_specs_table <- purrr::map(all_excel_sheets_cleaned_allot_specs_table, convert_from_excel_dates_to_datetime,
  col_name = "DateEntered"
)
```

## 3.0 Rename Columns 

There are many columns that we need to rename in the database.

The table "dmnYears" contains a code for entering in the document year in the "DocYear" column in other tables. In "dmnYears" year 1996 is coded as "7". Not sure why. The table "tblDocSpecs" contains only a "DocYear" column so we want to replace those coded values with the actual year of the document.

```{r Rename "ID" to "DocYear" in "dmnYears"}
all_excel_sheets_cleaned_allot_specs_table$dmnYears <- all_excel_sheets_cleaned_allot_specs_table$dmnYears %>% 
  dplyr::rename(DocYear = ID)

all_excel_sheets_cleaned_allot_specs_table$dmnYears
```

## 4.0 Join "dmnYears" and "tblDocSpecs"

The right join will match the "DocYear" value from the "dmnYears" table with the "DocYear" value in the "tblDocSpecs" table and replace the "DocYear" value in the "tblDocSpecs" table with the "Date_Year" from the "dmnYEars".

```{r right join "dmnYears" and "tblDocSpecs" by "DocYear"}
all_excel_sheets_cleaned_allot_specs_table$tblDocSpecs <- dplyr::right_join(all_excel_sheets_cleaned_allot_specs_table$dmnYears, all_excel_sheets_cleaned_allot_specs_table$tblDocSpecs, by = "DocYear")

all_excel_sheets_cleaned_allot_specs_table$tblDocSpecs
```

We will drop the "DocYear" column from the "tblDocSpecs" data frame, and then rename the "Date_Year" column to be called "AOI_Year". Renaming the column to "AOI_Year" better represents the meaning on the column. The "AOI_Year"

## TODO refactor to overwrite excel list instead of creating new objects

```{r drop "DocYear" from "tblDocSpecs" and rename to "AOI_Year"}
all_excel_sheets_cleaned_allot_specs_table$tblDocSpecs <-
  all_excel_sheets_cleaned_allot_specs_table$tblDocSpecs %>%
  dplyr::select(-(DocYear)) %>% 
  dplyr::rename(AOI_Year = Date_Year) %>% 
  dplyr::arrange(DocNo)
all_excel_sheets_cleaned_allot_specs_table$tblDocSpecs
```

Write Partially Cleaned Data to CSV File

```{r 4.1 write data to csv file, eval=FALSE}
openxlsx::write.xlsx(all_excel_sheets_cleaned_allot_specs_table, file.path("data", "01-intermediate-clean-excel-dates-and-join-docyear-on-table-docspecs.xlsx"))
```

***

## 5.0 Rename List of Data Frames

Rename the list to something smaller and easier to type.

```{r rename to "all_excel_sheets_cleaned"}
all_excel_sheets_cleaned <- all_excel_sheets_cleaned_allot_specs_table
```

## 6.0 Clean Up "tblTnELimits_Doc" and "tblDocSpecs"

Before we join the "tblTnELimits_Doc" with the "tblDocSpecs" on the "DocNo" column, we will use `dplyr::semi_join()` to see which rows in "tblDocSpecs" have a match in "tblTnELimits_Doc".

```{r semi-join }
dplyr::semi_join(all_excel_sheets_cleaned$tblDocSpecs,
  all_excel_sheets_cleaned$tblTnELimits_Doc,
  by = "DocNo"
)
```

There are 2,360 rows in the "tblDocSpecs" but there are only 2,302 matches. That means that there are 58 rows that do not match.

```{r nrows in "tblDocSpecs"}
all_excel_sheets_cleaned$tblDocSpecs %>% nrow()
```

## TODO ask why we only kept these columns

```{r drop columns from "tblTnELimits_Doc"}
all_excel_sheets_cleaned$tblTnELimits_Doc <-
  all_excel_sheets_cleaned$tblTnELimits_Doc %>%
  dplyr::select(Limitation, DocNo)
```

## TODO not sure if we need this anymore or if it was just for prototyping

Before we change "tblDocSpecs" we want to see how each type of join will affect the data.
The function `right_join()` will join matching values from "tblDocSpecs" into "tblTnELimits_Doc".

We created a new object "all_excel_sheets_cleaned_right_join" to temporarily store the data so we can compare against other types of joins.

```{r right join "tblDocSpecs" "tblTnELimits_Doc"}
all_excel_sheets_cleaned_right_join <- all_excel_sheets_cleaned

all_excel_sheets_cleaned_right_join$tblDocSpecs <- 
  dplyr::right_join(
    all_excel_sheets_cleaned_right_join$tblDocSpecs,
    all_excel_sheets_cleaned_right_join$tblTnELimits_Doc,
    by = "DocNo"
)
print(all_excel_sheets_cleaned_right_join$tblDocSpecs)
```

## TODO not sure if we need this anymore or if it was just for prototyping

We'll do the same thing as we just did with `right_join()` but this time we will use the function `full_join()`.

```{r full join "tblDocSpecs" "tblTnELimits_Doc"}
all_excel_sheets_cleaned_full_join <- all_excel_sheets_cleaned

all_excel_sheets_cleaned_full_join$tblDocSpecs <-
  dplyr::full_join(all_excel_sheets_cleaned_full_join$tblDocSpecs,
    all_excel_sheets_cleaned_full_join$tblTnELimits_Doc,
    by = "DocNo"
  )

all_excel_sheets_cleaned_full_join$tblDocSpecs
```

The anti join is telling us that there are 58 additional rows in the full join that did not match.

```{r anti join "tblDocSpecs" "tblTnELimits_Doc"}
anti_join(
  all_excel_sheets_cleaned_full_join$tblDocSpecs,
  all_excel_sheets_cleaned_right_join$tblDocSpecs
)
```

When we joined, the column "DocNo" in the sheet "tblDocSpecs" the new data was added 

```{r 6.1 arrange by DocNo}
all_excel_sheets_cleaned_full_join_arrange <-
  all_excel_sheets_cleaned_full_join

all_excel_sheets_cleaned_full_join_arrange$tblDocSpecs <- all_excel_sheets_cleaned_full_join$tblDocSpecs %>%
  arrange(DocNo)

print(all_excel_sheets_cleaned_full_join_arrange$tblDocSpecs)
```

## TODO decide if we want to replace the "N/A" strings with true NA values

We might decide to replace the "N/A" values are true NA values, but for now, let's replace "N/A" with "None"

```{r replace "N/A" with NA character}
# all_excel_sheets_cleaned_full_join_arrange$tblDocSpecs$Limitation <- str_replace_all(all_excel_sheets_cleaned_full_join_arrange$tblDocSpecs$Limitation, "N/A", NA_character_)
#
# View(all_excel_sheets_cleaned_full_join_arrange$tblDocSpecs)
```

The limitation column represents limitations placed on each allotment related to threatened and endangered species present on the allotment, or concerns related to T/E species. 

```{r string replace "N/A" with "None}
all_excel_sheets_cleaned_full_join_arrange$tblDocSpecs$Limitation <-
  str_replace_all(
    all_excel_sheets_cleaned_full_join_arrange$tblDocSpecs$Limitation,
    "N/A",
    "None"
  )

all_excel_sheets_cleaned_full_join_arrange$tblDocSpecs
```

Write out the partially cleaned data to a csv file.

```{r 6.1 write to csv, eval=FALSE}
openxlsx::write.xlsx(
  all_excel_sheets_cleaned_full_join_arrange,
  file.path("data", "02-intermediate-full-join-limitations-doc-specs.xlsx")
)
```

## Step 7 Clean Up "tblTnE_Doc"

```{r 7.1.0 drop duplicate common names}
all_excel_sheets_drop_duplicate_common_names <- all_excel_sheets_cleaned_full_join_arrange

all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc <-
  all_excel_sheets_cleaned_full_join_arrange$tblTnE_Doc %>%
  group_by(DocNo) %>%
  dplyr::distinct(CommonName)

all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc
```

Let's see how many rows were dropped when we used the distinct() function. 

```{r 7.1.1 check how many duplicates names were dropped}
full <- all_excel_sheets_cleaned_full_join_arrange$tblTnE_Doc$CommonName %>% length()

drop_dupl <- all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc$DocNo %>% length()

full - drop_dupl
```

```{r 7.1.2 write to csv, eval=FALSE}
openxlsx::write.xlsx(
  all_excel_sheets_drop_duplicate_common_names,
  file.path("data", "03-intermediate-drop-duplicate-common-names-tnedoc.xlsx")
)
```

### 7.2 Trim Whitespace from "tblTnE_Doc"

We need to visualize how many Common Names are for each group to understand how many times we need to perform a clean up.

```{r 7.2.1 check group size}
all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc %>% dplyr::group_size()
```

The leading whitespaces are difficult to identify. However, we can use the `unique()` function to see how many unique common names R thinks there are, and this should identify if there are common names with leading whitespace.

```{r 7.2.3 check unique common names}
all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc %>%
  pull(CommonName) %>%
  unique()
```

Then if we compare the unique common names after we trim the leading whitespace, we can tell that R thinks there are now less unique values.

```{r 7.2.4 check unique trim leading spaces}
all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc %>%
  dplyr::pull(CommonName) %>%
  stringr::str_trim() %>%
  unique()
```

```{r 7.2.5 trim leading whitespaces}
all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc$CommonName <-
  all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc %>%
  dplyr::pull(CommonName) %>%
  stringr::str_trim()
print(all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc)
```

## 7.3 Write "tblTnE_Doc" to CSV

```{r 7.3 write to csv, eval=FALSE}
openxlsx::write.xlsx(
  all_excel_sheets_drop_duplicate_common_names,
  file.path(
    "data",
    "04-intermediate-remove-leading-whitespaces-from-tblTnE_Doc.xlsx"
  )
)
```


## Step 8

Collapse each common name from tblTnE_Doc into single column.

```{r 8.1.0 collapse common names}
all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc_collapse <-
  all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc %>%
  summarise(CommonName = paste(CommonName, collapse = "; "))
print(all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc_collapse)
```

This equals the number of rows that we collapse using the `group_by` method.

```{r 8.1.1 check how many rows were collapsed}
orig <- all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc %>%
  nrow()
remov_dup <- all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc_collapse %>%
  nrow()

orig - remov_dup
```

Here we over-write the original data with the collapsed "CommonName" column.

```{r 8.1.2 overwrite "CommonName" column}
all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc <-
  all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc %>%
  summarise(CommonName = paste(CommonName, collapse = "; "))

print(all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc)
```

```{r 8.1.3 write to csv, eval=FALSE}
openxlsx::write.xlsx(
  all_excel_sheets_drop_duplicate_common_names,
  file.path(
    "data",
    "05-intermediate-collapse-common-names-from-tblTnE_Doc.xlsx"
  )
)
```

## TODO the  "Modified Time/Place of Grazing" in the "Limitation" has an extra space in the one of the values that we need to get rid of.

## TODO the "None" from the CommonName column in tblTnE_Doc is mutually exclusive, meaning that "None" cannot also exclusive. We decided to keep the "None" in the data and will 

## Step 9 Full Join `tblTnE_Doc` with `tblDocSpecs` by `DocNo`

```{r 9.1.0 full full "tblDocSpecs" "tblTnE_Doc"}
all_excel_sheets_drop_duplicate_common_names$tblDocSpecs <-# overwrite the tblDocSpecs
  full_join(all_excel_sheets_drop_duplicate_common_names$tblDocSpecs, # add to this table
          all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc, # with data from this table
          by = "DocNo") %>% # by the document number
  dplyr::relocate(CommonName, .before = Limitation) # rearrange columns

print(all_excel_sheets_drop_duplicate_common_names$tblTnELimits_Doc)
```

```{r temp}
all_excel_sheets_drop_duplicate_common_names$tblDocSpecs %>% names()
```

```{r temp}
all_excel_sheets_drop_duplicate_common_names$tblClimeChange_Doc %>% names()
```

### 9.2 Full Join with `tblDocSpecs` and `tblClimeChange_Doc` by `DocNo`

First we want to drop the `tblClimeChange_Doc$Date.Entered` and `tblClimeChange_Doc$id` columsn from the `tbltblClimeChange_Doc` because if we where to join them to `tblDocSpecs`
those columns it would be confusing as it would no longer refer to the originial data.

```{r 9.2.1 trim leading whitespace "ClimeChangeDoc"}
all_excel_sheets_drop_duplicate_common_names$tblClimeChange_Doc$ClimeChangeDoc <- all_excel_sheets_drop_duplicate_common_names$tblClimeChange_Doc %>% 
  pull(ClimeChangeDoc) %>% 
  str_trim()
```

```{r 9.2.2 string replace "N/A" with "None}
all_excel_sheets_drop_duplicate_common_names$tblClimeChange_Doc$ClimeChangeDoc <- 
all_excel_sheets_drop_duplicate_common_names$tblClimeChange_Doc$ClimeChangeDoc %>%
  stringr::str_replace_all(pattern = "N/A", replacement = "None")
print(all_excel_sheets_drop_duplicate_common_names$tblClimeChange_Doc)
```

The table `tblClimeChange_Doc` has duplicate entries for each document number that we want to combine together so that each document number has a single row. We can then remove these duplicates in a later step after we decide which values to keep.

## TODO optionally, we can decide to drop the `id` column from `tblClimeChange_Doc` if we decide its just an index column.

## TODO optionally, we can drop the `Date.Entered` column, or remove the duplicate dates

```{r 9.2.3 collapse tblClimeChange_Doc}
all_excel_sheets_drop_duplicate_common_names$tblClimeChange_Doc <- 
all_excel_sheets_drop_duplicate_common_names$tblClimeChange_Doc %>% 
  group_by(DocNo) %>% 
  summarise(ClimeChangeDoc = paste(ClimeChangeDoc, collapse = "; "), 
            id = paste(id, collapse = "; "),
            Date.Entered = paste(Date.Entered, collapse = "; ")
  )
print(all_excel_sheets_drop_duplicate_common_names$tblClimeChange_Doc)
```

We want to add climate change documents from `tblClimeChange_Doc` to `tblDocSpecs` using the columns `DocNo` and `ClimeChangeDoc` from the `tblClimeChange_Doc` table.

## TODO there are duplicate `DocNo` in the table `tblDocSpecs` we may want to run `dplyr::distinct()` on the table

## TODO also we want to consider which rows are preserved using a full join. It might be worth it to use an `anti_join()` to see what's going on first before the full join.

```{r 9.2.4 full join "tblDocSpecs" "tblClimeChange_Doc"}
all_excel_sheets_drop_duplicate_common_names$tblDocSpecs <- 
all_excel_sheets_drop_duplicate_common_names$tblDocSpecs %>% 
full_join(select(all_excel_sheets_drop_duplicate_common_names$tblClimeChange_Doc,
                 DocNo,
                 ClimeChangeDoc),
          by = c("DocNo")
          ) %>% 
  arrange(DocNo)
```

## TODO all the code chunks that say "Write to CSV" are actually "Write to XLSX"

Let's write out the data to an intermediate file for a closer look.

```{r 9.2.5 write to xlsx, eval=FALSE}
openxlsx::write.xlsx(
  all_excel_sheets_drop_duplicate_common_names,
  file.path(
    "data",
    "06-intermediate-full-join-tblClimeChange_Doc-tblDocSpecs.xlsx"
  )
)
```

Take a look at the data to see if the join was successful.

```{r 9.2.6 view tblDocSpecs}
print(all_excel_sheets_drop_duplicate_common_names$tblDocSpecs)
```

## TODO I think we also want to look at why some tables have information for some document numbers, but that information doesn't exist in other tables.

## Step 10 Collapse the "tblAllotStrategies" by "DocNo"

```{r temp}
all_excel_sheets <- all_excel_sheets_drop_duplicate_common_names

all_excel_sheets$tblAllotStrategies %>% names()
```

There are a few leading whitespace in the "txtGrazingStrategy" that we need to get rid.

```{r 10.1.0 trim leading whitespace from "txtGrazingStrategy"}
all_excel_sheets$tblAllotStrategies$txtGrazingStrategy <- 
all_excel_sheets$tblAllotStrategies %>% 
  pull(txtGrazingStrategy) %>% 
  stringr::str_trim()
print(all_excel_sheets$tblAllotStrategies)
```

```{r temp}
all_excel_sheets$tblAllotStrategies$txtGrazingStrategy %>% unique()
```

```{r 10.1.1 collapse "tblAllotStrategies" by DocNo}
all_excel_sheets$tblAllotStrategies <- 
all_excel_sheets$tblAllotStrategies %>% 
  rename(DocNo = intDocNo) %>% 
  dplyr::group_by(DocNo) %>%
  summarize(ID = paste(ID, collapse = "; "),
            txtAllotmentName = paste(txtAllotmentName, collapse = "; "),
            txtGrazingStrategy = paste(txtGrazingStrategy, collapse = "; ")
  )

print(all_excel_sheets$tblAllotStrategies)
```

```{r 10.1.1 write to xlsx, eval=FALSE}
write.xlsx(
  all_excel_sheets,
  file.path(
    "data",
    "07-intermediate-collapse-tblAllotStrategies.xlsx"
  )
)
```

```{r temp}
all_excel_sheets$tblDocSpecs %>% names() 
```

```{r temp}
all_excel_sheets$tblAllotStrategies %>% names() 
```


```{r 10.1.2}
full_join(all_excel_sheets$tblDocSpecs, 
          all_excel_sheets$tblAllotStrategies,
          by = c("DocNo")
)
```

```{r 10.1.3 write to xlsx, eval=FALSE}
write.xlsx(
  all_excel_sheets,
  file.path(
    "data",
    "08-intermediate-full-join-tblDocSpecs-tblAllotStrategies.xlsx"
  )
)
```

## Step 11

```{r temp}
all_excel_sheets$tblPastureSpecs %>% names()
```

```{r temp}
all_excel_sheets$dmnStockingUnit %>% names()
```

```{r temp}
all_excel_sheets$tblPastureSpecs$PermitUnit %>% class()
```

```{r temp}
all_excel_sheets$dmnStockingUnit$Unit %>% class()
```

```{r temp}
all_excel_sheets$tblPastureSpecs$PermitUnit <- 
all_excel_sheets$tblPastureSpecs$PermitUnit %>% as.numeric()
```

```{r temp}
all_excel_sheets$tblPastureSpecs$PermitUnit %>% class()
```

## Step 11

```{r rename "ID" to "PermitUnit" in dmnStockingUnit}
all_excel_sheets$dmnStockingUnit <-
all_excel_sheets$dmnStockingUnit %>% rename(PermitUnit = ID)
```

```{r 11.0.0}
all_excel_sheets$tblPastureSpecs <- 
right_join(all_excel_sheets$dmnStockingUnit,
           all_excel_sheets$tblPastureSpecs,
           by = c("PermitUnit")
           )

print(all_excel_sheets$tblPastureSpecs)
```

## TODO optionally drop the "PermitUnit" column and rename the "Unit" column to "PermitUnit"

```{r 11.1.0 write to xlsx, eval=FALSE}
write.xlsx(
  all_excel_sheets,
  file.path(
    "data",
    "09-intermediate-right-join-dmnStockingUnit-tblPastureSpecs.xlsx"
  )
)
```

## TODO also need to replace the permit type tblPastureSpecs with the livestock type from dmnLivestockType

```{r 11.2.0}
all_excel_sheets$tblPastureSpecs <- 
right_join(all_excel_sheets$dmnLivestockType,
           all_excel_sheets$tblPastureSpecs,
           by = c("ID" = "PermitType")
           )
print(all_excel_sheets$tblPastureSpecs)
```

```{r temp}
all_excel_sheets$tblPastureSpecs %>% names()
```


docno, pasture name, livestock type, permit

```{r drop "ID" and "PermitUnit" form tblPastureSpecs}
all_excel_sheets$tblPastureSpecs <- 
all_excel_sheets$tblPastureSpecs %>% 
  dplyr::select(-c("ID", "PermitUnit")) %>% 
  dplyr::rename(PermitUnit = Unit)
print(all_excel_sheets$tblPastureSpecs)
```

```{r}
purrr::map(all_excel_sheets, names)
```

## TODO figure out why we're its returning a NULL error message
## TODO all if we change the "intDocNo" column rgiht here, then we will have to replace all of the intDocNo with DocNo

```{r map convert column to "DocNo"}
# purrr::map(all_excel_sheets, rename_all_docno_columns, col_name = "intDocNo")
```

```{r}
all_excel_sheets$tblPastureSpecs <- 
all_excel_sheets$tblPastureSpecs %>% 
  dplyr::arrange(intDocNo) %>% 
  dplyr::relocate(c("intDocNo", 
                    "txtPastureName", 
                    "LivestockType", 
                    "PermitUnit" ),
                  .before = 1)
print(all_excel_sheets$tblPastureSpecs)
```

```{r 11.2.1 write to xlsx, eval=FALSE}
write.xlsx(
  all_excel_sheets,
  file.path(
    "data",
    "11-intermediate-rename-tblPastureSpecs.xlsx"
  )
)
```

## TODO one of the things I want to better understand is joins, and I'm thinking that there must be a package out there that compares what rows are kept with full joins vs left joins vs right joins vs inner joins

```{r}
all_excel_sheets$tblPastureSpecs %>% names()
```

```{r}
all_excel_sheets$tblPastureSpecs %>% dplyr::group_by(intDocNo)
```


```{r}
all_excel_sheets$tblPastureSpecs <- 
all_excel_sheets$tblPastureSpecs %>% 
  dplyr::group_by(intDocNo) %>% 
  dplyr::summarize(txtPastureName = paste(txtPastureName, collapse = "; "),
                   DateOn = paste(DateOn, collapse = "; "),
                   DateOff = paste(DateOff, collapse = "; "),
                   LivestockType = paste(LivestockType, collapse = "; "),
                   PermitUnit = paste(PermitUnit, collapse = "; "),
                   PermitNo = paste(PermitNo, collapse = "; "),
                   Rested = paste(Rested, collapse = "; "))
print(all_excel_sheets$tblPastureSpecs)
```

```{r temp}
all_excel_sheets$tblPastureSpecs %>% names()
```
Note: we dropped the "Pasture_ID" column from "tblPastureSpecs".

## TODO give some thought about how these documents fit together and could be stored inside of database

```{r 11.3.1 write to xlsx, eval=FALSE}
write.xlsx(
  all_excel_sheets,
  file.path(
    "data",
    "12-collapse-tblPastureSpecs.xlsx"
  )
)
```

```{r temp}
all_excel_sheets$tblPastureSpecs %>% names()
```

```{r temp}
all_excel_sheets$tblAllotStrategies %>% names()
```
```{r}
all_excel_sheets$tblAllotStrategies <- 
all_excel_sheets$tblAllotStrategies %>% dplyr::select(-c("ID"))
```

```{r}
all_excel_sheets$tblDocSpecs <- 
full_join(all_excel_sheets$tblDocSpecs,
          all_excel_sheets$tblPastureSpecs,
          by = c("DocNo" = "intDocNo"))
# View(all_excel_sheets$tblDocSpecs)
```

```{r 11.4.0 write to xlsx, eval=FALSE}
write.xlsx(
  all_excel_sheets,
  file.path(
    "data",
    "13-full-join-tblPastureSpecs-tblDocSpecs.xlsx"
  )
)
```

```{r temp}
all_excel_sheets$tblAllotStrategies %>% names()
```


### 11.5

```{r}
all_excel_sheets<- all_excel_sheets

all_excel_sheets$tblDocSpecs <- 
full_join(all_excel_sheets$tblDocSpecs,
          all_excel_sheets$tblAllotStrategies,
          by = "DocNo")
print(all_excel_sheets$tblDocSpecs)
```

```{r 11.5.0 write to xlsx, eval=FALSE}
openxlsx::write.xlsx(
  all_excel_sheets,
  file.path(
    "data",
    "14-full-join-tblAllotStrategies-tblDocSpecs.xlsx"
  )
)
```

### 12

```{r temp}
all_excel_sheets$tblAllotSpecs %>% names()
```

```{r temp}
all_excel_sheets$tblAllotSpecs %>% str()
```

## TODO remeber `tibble::rowid_to_column("index")`

```{r}
compare_date_columns_tblAllotSpecs <- 
  all_excel_sheets$tblAllotSpecs$datValidStart %in%
  all_excel_sheets$tblAllotSpecs$datPermitStart %>% 
  as_tibble() %>% 
  tibble::rowid_to_column("index")
print(compare_date_columns_tblAllotSpecs)
```

```{r}
bad_dates_tibble <- compare_date_columns_tblAllotSpecs %>% 
  dplyr::filter(value == FALSE)
print(bad_dates_tibble)
```

## TODO Cameron: some of the dates were entered incorrectly and will fix manually

```{r}
bad_dates <- bad_dates_tibble$index

print(bad_dates)

str(bad_dates)
```

## TODO highlight all of the date discrepancies in the `tblAllotSpecs` using the openxlsx package

## TODO need explain why you changed those date values manually

```{r}
all_excel_sheets$tblAllotSpecs$datValidStart[49] <- lubridate::ymd_hms("")
```

#### This is the hex value for highlight in Excel "ffff00"

```{r temp}
all_excel_sheets$tblAllotSpecs %>% names()
```


## TODO add an index column to each of the data frames in the list

```{r}
all_excel_sheets$tblAllotSpecs %>% 
  as_tibble() %>% 
  tibble::rowid_to_column("index") %>% 
  dplyr::slice(bad_dates) %>% 
  select(c("datValidStart", "datValidEnd", "datPermitStart", "datPermitEnd"))

```

```{r temp}
all_excel_sheets$tblAllotSpecs %>% names()
```

```{r}
compare_end_date_columns_tblAllotSpecs <- 
  all_excel_sheets$tblAllotSpecs$datValidEnd %in%
  all_excel_sheets$tblAllotSpecs$datPermitEnd %>% 
  as_tibble() %>% 
  tibble::rowid_to_column("index")
print(compare_end_date_columns_tblAllotSpecs)
```

```{r}
all_excel_sheets$tblAllotSpecs %>% names()
```

The `tblAllotSpecs$txtAllowedUse` was coded in a interesting way, if the AOI mentioned that within a pasture, you could graze x% percent in the upland and y% in the riparian area, then the data was coded as what ever use value higher, however this encoding does not take into account that within each pasture there are keys areas that should be grazed differently, i.e., grazed more or grazed less based on the ecological site characteristics

```{r}
# View(all_excel_sheets$tblDocSpecs)
```

```{r}
View(all_excel_sheets$tblAllotSpecs)
```


## TODO would it be possible to pull the Allowable Use using OCR and then a keyword filter algorithm or natural language processing?

## TODO there are bad unparsed dates in tblAllotSpecs

## TODO collapse tblAllotmentKeySpecies and join to tblDocSpecs

## TODO collapse tblAdaptManDesc_doc and join to tblDocSpecs

## duplicates in the tblDocSpecs collapse on DocNo, but first we need to check if the hyperlink path will match

## look into what database design (MYSQL or document database like MongoDB) that we could use to hyperlink to the PDF

```{r}
all_excel_sheets$tblAllotSpecs %>% dlookr::diagnose()
```

```{r temp}
all_excel_sheets$tblAllotSpecs %>% names()
```

```{r}
lubridate::ymd_hms("1995-01-01T00:00:00")
```

```{r}
# vector[1] < lubridate::ymd_hms("1995-01-01T00:00:00", tz = "MST")
```

## TODO create a function that checks valid start and end dates
## valid start: anytime after 1995-01-01T00:00:00
## valid end: anytime before 2019-01-01T00:00:00

```{r eval=FALSE}
# vector <- all_excel_sheets$tblAllotSpecs %>% pull(datPermitStart)
# 
# for (i in (1:length(vector))) {
#   print(vector[i] < lubridate::ymd_hms("1995-01-01T00:00:00", tz = "MST")) |
#     
# }
```

```{r}
# check_if_date_range_is_valid <- function(date_column){
#   if date_column[i] < lubridate::ymd_hms("1995-01-01T00:00:00")
# }
```

```{r}
all_excel_sheets$tblAllotSpecs %>% dlookr::diagnose()
```

```{r temp}
all_excel_sheets$tblAllotSpecs %>% names()
```

```{r}
all_excel_sheets$tblAllotSpecs <- 
all_excel_sheets$tblAllotSpecs %>% 
  dplyr::select(-c("AllotSpec_ID", "DateEntered")) %>% 
  dplyr::distinct()
```

intDocNo numbers 371 and 372 and messed up. Drop the NA from 372, and keep the 372 that has the correct date.

```{r here}
all_excel_sheets$tblAllotSpecs <- 
  all_excel_sheets$tblAllotSpecs %>% tidyr::drop_na(txtAllotName)
```

```{r}
all_excel_sheets$tblAllotSpecs %>% names()
```

```{r}
cleaned_392_allotspecs <- 
all_excel_sheets$tblAllotSpecs %>% 
  dplyr::filter(intDocNo == "392") %>% 
  dplyr::filter(datPermitStart == lubridate::ymd("1996-05-05") & 
                datPermitEnd == lubridate::ymd("1996-10-11")
                )
all_excel_sheets$tblAllotSpecs <- 
all_excel_sheets$tblAllotSpecs %>% 
  dplyr::filter(intDocNo != "392") %>% 
  dplyr::add_row(cleaned_392_allotspecs) %>% 
  dplyr::arrange(intDocNo)

View(all_excel_sheets$tblAllotSpecs)
```

```{r}
all_excel_sheets$tblAllotSpecs <- 
all_excel_sheets$tblAllotSpecs %>% 
  group_by(intDocNo) %>% 
  summarise(txtAllotName = paste(txtAllotName, collapse = "; "),
            datPermitStart = paste(datPermitStart, collapse = "; "),
            datPermitEnd = paste(datPermitEnd, collapse = "; "),
            txtAllowedUse = paste(txtAllowedUse, collapse = "; "))
View(all_excel_sheets$tblAllotSpecs)
```

```{r}
all_excel_sheets$tblAllotSpecs %>% dlookr::diagnose()
```

```{r}
all_excel_sheets$tblDocSpecs <- 
  dplyr::full_join(all_excel_sheets$tblAllotSpecs, 
                  all_excel_sheets$tblDocSpecs, 
                  by = c("intDocNo" = "DocNo")
                  )
```

```{r}
View(all_excel_sheets$tblDocSpecs)
```

```{r}
write.xlsx(all_excel_sheets, 
           file = file.path("data", "15-full-join-tblAllotSpecs-tblDocSpecs.xlsx"))
```

## 

```{r}
all_excel_sheets$tblAllotmentKeySpecies %>% names()
```

```{r}
all_excel_sheets$tblAllotmentKeySpecies$txtAllotKeySpecies <- 
all_excel_sheets$tblAllotmentKeySpecies$txtAllotKeySpecies %>% stringr::str_trim()
```

add nones to the blank key species

```{r}
all_excel_sheets$tblAllotmentKeySpecies %>% dlookr::diagnose()
```

```{r}
View(all_excel_sheets$tblAllotmentKeySpecies)
```

```{r}
all_excel_sheets$tblAllotmentKeySpecies <- 
all_excel_sheets$tblAllotmentKeySpecies %>% 
  tidyr::replace_na(replace = list(txtAllotKeySpecies = "None"))
```

```{r}
View(all_excel_sheets$tblAllotmentKeySpecies)
```

## TODO it might be interesting to figure out which document numbers are missing from the tblDocSpecs

```{r}
all_excel_sheets$tblAllotmentKeySpecies %>% dlookr::diagnose()
```

```{r}
all_excel_sheets$tblAllotmentKeySpecies <- 
all_excel_sheets$tblAllotmentKeySpecies %>% 
  dplyr::select(c("intDocNo", "txtAllotKeySpecies")) %>% 
  dplyr::distinct()
```

```{r}
all_excel_sheets$tblAllotmentKeySpecies %>% dlookr::diagnose()
```


```{r}
all_excel_sheets$tblAllotmentKeySpecies <- 
all_excel_sheets$tblAllotmentKeySpecies %>% 
  group_by(intDocNo) %>%
  summarise(intDocNo = intDocNo[1],
            txtAllotKeySpecies = paste(txtAllotKeySpecies, collapse = "; ")
            )
View(all_excel_sheets$tblAllotmentKeySpecies)
```

```{r}
all_excel_sheets$tblDocSpecs <- 
  dplyr::full_join(all_excel_sheets$tblAllotmentKeySpecies,
                   all_excel_sheets$tblDocSpecs,
                   by = "intDocNo")

all_excel_sheets$tblDocSpecs %>% View()
```

```{r}
write.xlsx(all_excel_sheets, 
           file = file.path("data",
                            "16-full-join-tblAllotmentKeySpecies-tblDocSpecs.xlsx"))
```

##

```{r}
all_excel_sheets$tblAdaptManDesc_doc %>% names()
```

```{r}
all_excel_sheets$tblAdaptManDesc_doc %>% dlookr::diagnose()
```

```{r}
all_excel_sheets$tblAdaptManDesc_doc$AdaptManDesc %>% unique()
```

```{r}
all_excel_sheets$tblAdaptManDesc_doc$AdaptManDesc <- 
all_excel_sheets$tblAdaptManDesc_doc$AdaptManDesc %>% stringr::str_trim()
```

```{r}
all_excel_sheets$tblAdaptManDesc_doc$AdaptManDesc %>% unique()
```

```{r}
all_excel_sheets$tblAdaptManDesc_doc$AdaptManDesc <- 
all_excel_sheets$tblAdaptManDesc_doc$AdaptManDesc %>% 
stringr::str_replace(pattern = "Trial/Error, Flexible Use, Learning and Monitoringr",
            replace = "Trial/Error, Flexible Use, Learning and Monitoring")
```

```{r}
all_excel_sheets$tblAdaptManDesc_doc$AdaptManDesc %>% unique()
```

```{r}
all_excel_sheets$tblAdaptManDesc_doc %>% View()
```

```{r}
all_excel_sheets$tblAdaptManDesc_doc$AdaptManDesc <- 
all_excel_sheets$tblAdaptManDesc_doc$AdaptManDesc %>% 
stringr::str_replace(pattern = "Trial/Error, Flexible Use, Learning and Monitoring",
            replace = "Trial/Error; Flexible Use; Learning and Monitoring")
```

```{r}
all_excel_sheets$tblAdaptManDesc_doc$AdaptManDesc %>% unique()
```

```{r}
all_excel_sheets$tblAdaptManDesc_doc %>% dplyr::group_by(AdaptManDesc) %>% dplyr::count()
```

```{r}
all_excel_sheets$tblAdaptManDesc_doc$AdaptManDesc <- 
all_excel_sheets$tblAdaptManDesc_doc$AdaptManDesc %>% 
stringr::str_replace(pattern = "None",
            replace = "No AM Present")
```

```{r}
all_excel_sheets$tblAdaptManDesc_doc %>% dplyr::group_by(AdaptManDesc) %>% dplyr::count()
```

```{r}
all_excel_sheets$tblAdaptManDesc_doc %>% View()
```

```{r}
all_excel_sheets$tblAdaptManDesc_doc %>% names()
```

```{r}
all_excel_sheets$tblAdaptManDesc_doc <- 
all_excel_sheets$tblAdaptManDesc_doc %>% 
  dplyr::select(c("DocNo", "AdaptManDesc")) %>% 
  dplyr::distinct()
View(all_excel_sheets$tblAdaptManDesc_doc)
```

```{r}
all_excel_sheets$tblAdaptManDesc_doc <- 
all_excel_sheets$tblAdaptManDesc_doc %>% 
  dplyr::group_by(DocNo) %>% 
  summarise(DocNo = DocNo,
            AdaptManDesc = paste(AdaptManDesc, collapse = "; ")
            )
View(all_excel_sheets$tblAdaptManDesc_doc)
```

```{r}
all_excel_sheets$tblAdaptManDesc_doc %>% dplyr::group_by(AdaptManDesc) %>% dplyr::count()
```

```{r}
all_excel_sheets$tblAdaptManDesc_doc$AdaptManDesc %>% unique()
```

```{r}
all_excel_sheets$tblAdaptManDesc_doc$AdaptManDesc <- 
all_excel_sheets$tblAdaptManDesc_doc$AdaptManDesc %>% 
stringr::str_replace(pattern = "Flexible Use; No AM Present",
                     replace = "No AM Present; Flexible Use")
```

```{r}
all_excel_sheets$tblAdaptManDesc_doc %>% dplyr::group_by(AdaptManDesc) %>% dplyr::count()
```


