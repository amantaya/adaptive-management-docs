---
title: "Clean Up Tables from Access Database"
author: "Cameron Burleson"
date: "3/28/2022"
output:
  pdf_document: default
  html_document: default
---

# Setup 

Remove all of the objects from the R environment to start fresh every time.

```{r remove objects}
rm(list = ls())
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "~/adaptive-management-docs")
```

```{r load all packages}
source("packages.R")
```

```{r load custom functions}
source("functions.R")
```

# Load Data

```{r add file path}
path_to_excel_file <- file.path("data", "adaptive_management_documents_asessment_export_all_tables_from_access.xlsx")

print(path_to_excel_file)
```

Read in the sheet names from the Excel workbook.

```{r get sheet names}
sheet_names <- openxlsx::getSheetNames(path_to_excel_file)

print(sheet_names)
```

```{r load in data from Excel}
all_excel_sheets_list <- lapply(sheet_names, openxlsx::read.xlsx, xlsxFile = path_to_excel_file)

all_excel_sheets_list
```

The "convert_from_excel_dates_to_datetime" function now uses a column name parameter that performs the clean up function on an column in the data frame that matches the column name supplied in the function parameter.

```{r}
names(all_excel_sheets_list) <- sheet_names

names(all_excel_sheets_list)
```

```{r}
all_excel_sheets_list$tblTnELimits_Doc
```

```{r}
df <- all_excel_sheets_list$tblTnELimits_Doc

convert_from_excel_dates_to_datetime(df, "Date.Entered")
```

```{r map custom clean dates fucntion to list of data frames}
all_excel_sheets_cleaned_date_entered <- purrr::map(all_excel_sheets_list,
                                                    convert_from_excel_dates_to_datetime,
                                                    col_name = "Date.Entered")
```

The "CodingDate" column means exactly the same as "Date.Entered" and we can rename that column to be the same thing. Then we could run our function on the previously names "CodingDate" column.

The "DateOn" and "DateOff" columns are the dates that cows were turned out onto pasture and removed from pastures. These columns also need to be converted into Date class.

In the "DocSpecs" data frame the "DocYear" column was coded in using a table of codes from the dmnSpecs

We want to keep only these tables from the Access database.

Rename each element in the list by the name of the Excel sheet.


```{r}
all_excel_sheets_cleaned_dateon <- purrr::map(all_excel_sheets_cleaned_date_entered,
                                                convert_from_excel_dates_to_datetime,
                                                col_name = "DateOn")
```

```{r}
all_excel_sheets_cleaned_dateoff <- purrr::map(all_excel_sheets_cleaned_dateon,
                                                convert_from_excel_dates_to_datetime,
                                                col_name = "DateOff")
```

```{r}
all_excel_sheets_cleaned_dateoff <- purrr::map(all_excel_sheets_cleaned_dateon,
                                                convert_from_excel_dates_to_datetime,
                                                col_name = "DateOff")
```

```{r}
names(all_excel_sheets_cleaned_dateoff$tblDocSpecs)
```


```{r}
all_excel_sheets_cleaned_coding_date <- purrr::map(all_excel_sheets_cleaned_dateoff,
                                                convert_from_excel_dates_to_datetime,
                                                col_name = "CodingDate")
```

The datetimes below are in the wrong time zone. They are displaying in the UTC time zone, but the data was actually entered in with GMT -7 time zone. 

```{r}
names(all_excel_sheets_cleaned_coding_date$tblAmendSpecs)
```


```{r}
all_excel_sheets_cleaned_datdate_entered <- purrr::map(all_excel_sheets_cleaned_coding_date,
                                                convert_from_excel_dates_to_datetime,
                                                col_name = "datDate.Entered")
```


```{r}
all_excel_sheets_cleaned_datdate_entered$tblAmendSpecs
```

```{r}
names(all_excel_sheets_cleaned_datdate_entered$tblAllotSpecs)
```

```{r}
all_excel_sheets_cleaned_allot_specs_table <- purrr::map(all_excel_sheets_cleaned_datdate_entered,
                                                convert_from_excel_dates_to_datetime,
                                                col_name = "datValidStart")

all_excel_sheets_cleaned_allot_specs_table <- purrr::map(all_excel_sheets_cleaned_allot_specs_table,
                                                convert_from_excel_dates_to_datetime,
                                                col_name = "datValidEnd")

all_excel_sheets_cleaned_allot_specs_table <- purrr::map(all_excel_sheets_cleaned_allot_specs_table,
                                                convert_from_excel_dates_to_datetime,
                                                col_name = "datPermitStart")

all_excel_sheets_cleaned_allot_specs_table <- purrr::map(all_excel_sheets_cleaned_allot_specs_table,
                                                convert_from_excel_dates_to_datetime,
                                                col_name = "datPermitEnd")

all_excel_sheets_cleaned_allot_specs_table <- purrr::map(all_excel_sheets_cleaned_allot_specs_table,
                                                convert_from_excel_dates_to_datetime,
                                                col_name = "DateEntered")
```

```{r}
all_excel_sheets_cleaned_allot_specs_table$dmnYears

all_excel_sheets_cleaned_allot_specs_table$tblDocSpecs
```

```{r}
all_excel_sheets_cleaned_allot_specs_table$dmnYears <- all_excel_sheets_cleaned_allot_specs_table$dmnYears %>% dplyr::rename(DocYear = ID)

all_excel_sheets_cleaned_allot_specs_table$dmnYears
```

The table "dmnYears" contains a code for entering in the document year in the "DocYear" column. Year 1996 is coded as "7". The "tblDocSpecs" contains only a "DocYear" column so we want to replace those coded values with the actual year of the document.

```{r}
# match the DocYear value from the "dmnYears" data frame with 
# the DocYear value in the "tblDocSpecs" data frame
# and replace the "DocYear" value in the "tblDocSpecs" data 
# with the "Date_Year" from the "dmnYEars"

all_excel_sheets_cleaned_allot_specs_table$tblDocSpecs <- dplyr::right_join(all_excel_sheets_cleaned_allot_specs_table$dmnYears, all_excel_sheets_cleaned_allot_specs_table$tblDocSpecs, by = "DocYear")

all_excel_sheets_cleaned_allot_specs_table$tblDocSpecs
```

We will drop the "DocYear" column from the "tblDocSpecs" data frame, and then rename the "Date_Year" column to be called "AOI_Year". 

```{r}
all_excel_sheets_cleaned_allot_specs_table$tblDocSpecs <- 
  all_excel_sheets_cleaned_allot_specs_table$tblDocSpecs %>% 
  dplyr::select(-(DocYear))
```

```{r}
all_excel_sheets_cleaned_allot_specs_table$tblDocSpecs <- 
all_excel_sheets_cleaned_allot_specs_table$tblDocSpecs %>% rename(AOI_Year = Date_Year)

all_excel_sheets_cleaned_allot_specs_table$tblDocSpecs
```

```{r}
all_excel_sheets_cleaned_allot_specs_table$tblDocSpecs <- 
  all_excel_sheets_cleaned_allot_specs_table$tblDocSpecs %>% dplyr::arrange(DocNo)

all_excel_sheets_cleaned_allot_specs_table
```

```{r}
names(all_excel_sheets_cleaned_allot_specs_table)
```

### Write Partially Cleaned Data to CSV File

```{r Write Intermediate Data to CSV}
openxlsx::write.xlsx(all_excel_sheets_cleaned_allot_specs_table, file.path("data", "01-intermediate-clean-excel-dates-and-join-docyear-on-table-docspecs.xlsx"))
```

Rename the list to something smaller and easier to type.

```{r}
# TODO overwrite the all_excel_sheets objects during each step to reduce
# the number of objects in the environment because its starting to get confusing
# about which object is from the previous step
all_excel_sheets_cleaned <- all_excel_sheets_cleaned_allot_specs_table
```

Join the "tblTnELimits_Doc" with the "tblDocSpecs" on the "DocNo" column.

```{r}
dplyr::semi_join(all_excel_sheets_cleaned$tblDocSpecs,
                 all_excel_sheets_cleaned$tblTnELimits_Doc,
                 by = "DocNo")
```

```{r}
all_excel_sheets_cleaned$tblTnELimits_Doc
```


```{r}
all_excel_sheets_cleaned$tblTnELimits_Doc <- 
  all_excel_sheets_cleaned$tblTnELimits_Doc %>%
  dplyr::select(Limitation, DocNo)

all_excel_sheets_cleaned_right_join <- all_excel_sheets_cleaned

all_excel_sheets_cleaned_right_join$tblDocSpecs <- dplyr::right_join(all_excel_sheets_cleaned_right_join$tblDocSpecs,                                                  all_excel_sheets_cleaned_right_join$tblTnELimits_Doc,
                  by = "DocNo")

all_excel_sheets_cleaned_right_join$tblDocSpecs
```


```{r}
all_excel_sheets_cleaned_full_join <- all_excel_sheets_cleaned

all_excel_sheets_cleaned_full_join$tblDocSpecs <- 
  dplyr::full_join(all_excel_sheets_cleaned$tblDocSpecs,
                   all_excel_sheets_cleaned$tblTnELimits_Doc, 
                   by = "DocNo")

all_excel_sheets_cleaned_full_join$tblDocSpecs
```

The anti join is telling us that there are 58 additional rows in the full join that did not match.

```{r}
anti_join(all_excel_sheets_cleaned_full_join$tblDocSpecs,
          all_excel_sheets_cleaned_right_join$tblDocSpecs)
```

When we joined, the column "DocNo" in the sheet "tblDocSpecs" the new data was added 

```{r}
all_excel_sheets_cleaned_full_join_arrange <- 
  all_excel_sheets_cleaned_full_join

all_excel_sheets_cleaned_full_join_arrange$tblDocSpecs <- all_excel_sheets_cleaned_full_join$tblDocSpecs %>% 
  arrange(DocNo)

print(all_excel_sheets_cleaned_full_join_arrange$tblDocSpecs)
```

We might decide to replace the "N/A" values are true NA values, but for now, let's replace "N/A" with "None"
```{r}
# all_excel_sheets_cleaned_full_join_arrange$tblDocSpecs$Limitation <- str_replace_all(all_excel_sheets_cleaned_full_join_arrange$tblDocSpecs$Limitation, "N/A", NA_character_)
# 
# View(all_excel_sheets_cleaned_full_join_arrange$tblDocSpecs)
```

The limitation column represents limitations placed on each allotment related to threatened and endangered species present on the allotment, or concerns related to T/E species. 

```{r}
all_excel_sheets_cleaned_full_join_arrange$tblDocSpecs$Limitation <-
  str_replace_all(all_excel_sheets_cleaned_full_join_arrange$tblDocSpecs$Limitation, 
                  "N/A", 
                  "None")

all_excel_sheets_cleaned_full_join_arrange$tblDocSpecs
```

### Write Partially Cleaned Data Step 02

```{r}
openxlsx::write.xlsx(all_excel_sheets_cleaned_full_join_arrange, 
                     file.path("data", "02-intermediate-full-join-limitations-doc-specs.xlsx"))
```

## Step 03

```{r}
all_excel_sheets_cleaned_full_join_arrange$tblTnE_Doc
```

```{r}
all_excel_sheets_drop_duplicate_common_names <- all_excel_sheets_cleaned_full_join_arrange

all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc <-
  all_excel_sheets_cleaned_full_join_arrange$tblTnE_Doc %>%
  group_by(DocNo) %>% 
  dplyr::distinct(CommonName)

all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc
```

Let's see how many rows were dropped when we used the distinct() function. 

```{r}
full <- all_excel_sheets_cleaned_full_join_arrange$tblTnE_Doc$CommonName %>% length()

drop_dupl <- all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc$DocNo %>% length()

full - drop_dupl
```

### Write Intermediate Data to CSV Step 03

```{r}
openxlsx::write.xlsx(all_excel_sheets_drop_duplicate_common_names,
                     file.path("data", "03-intermediate-drop-duplicate-common-names-tnedoc.xlsx"))
```

## Step 04

```{r}
all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc
```

We need to visualize how many Common Names are for each group to understand how many times we need to perform a clean up.

```{r}
all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc %>% dplyr::group_size()
```

```{r}
all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc %>% 
  pull(CommonName) %>% 
  unique()
```

```{r}
all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc %>% 
  dplyr::pull(CommonName) %>%
  stringr::str_trim() %>% 
  unique()
```

```{r}
all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc$CommonName <- 
all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc %>% 
  dplyr::pull(CommonName) %>%
  stringr::str_trim()
print(all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc)
```

### Write Partially Cleaned Data to CSV Step 04

```{r}
openxlsx::write.xlsx(all_excel_sheets_drop_duplicate_common_names, 
                     file.path("data",
                               "04-intermediate-remove-leading-whitespaces-from-tblTnE_Doc.xlsx"))
```


## Step 05

Collapse each common name from tblTnE_Doc into single column.

```{r}
all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc_collapse <- 
all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc %>% 
  summarise(CommonName = paste(CommonName, collapse = "; "))
print(all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc_collapse)
```

This equals the number of rows that we collapse using the `group_by` method.

```{r}
orig <- all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc %>% 
  nrow()
remov_dup <- all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc_collapse %>%
  nrow()

orig - remov_dup
```

Here we over-write the original data with the collapsed "CommonName" column.

```{r}
all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc <- 
all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc %>% 
  summarise(CommonName = paste(CommonName, collapse = "; "))
print(all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc)
```


## Step 05

```{r}
openxlsx::write.xlsx(
  all_excel_sheets_drop_duplicate_common_names,
  file.path("data",
            "05-intermediate-collapse-common-names-from-tblTnE_Doc.xlsx"))
```


### TODO
The the  "Modified Time/Place of Grazing" in the "Limitation" has an extra space in the one of the values that we need to get rid of.

```{r}
all_excel_sheets_drop_duplicate_common_names
```


The "None" from the CommonName column in tblTnE_Doc is mutually exclusive, meaning that "None" cannot also exclusive.

```{r}
all_excel_sheets_drop_duplicate_common_names$tblTnE_Doc %>% dplyr::filter(group_size() >1)

```

We also need to merge the common names from tblTnE_Doc each common name is in multiple rows, merge into a single row, separate each value with a comma.

```{r}

```


```{r}
# tblAllotSpecs

# tblAllotmentKeySpecies

# tblAllotSpecs

# tblAllotStrategies

# tblAmendSpecs

# tblClimeChange_Doc

# tblPastureSpecs
```



